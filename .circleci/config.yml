version: 2.1

workflows:
  version: 2.1
  build:
    jobs:
      - main-job

jobs:
  main-job:
    executor: main-exec
    steps:
      - checkout
      - configure-system
      - install-webpy
      - install-webauthn

executors:
  main-exec:
    # docker:
    #   - image: circleci/node:10
    #   - image: circleci/postgres:10
    machine:
      image: ubuntu-1604:202010-01
    environment:
      COOKIES: ~/cookies
      VERBOSE: brief
      HTTPD_ERROR_LOG: /var/log/apache2/error.log
      CHAISE_BASE_URL: http://localhost/chaise
      ERMREST_URL: http://localhost/ermrest
      SHARDING: "true"

commands:
  configure-system:
    steps:
      - run: 
          name: Initalize
          command: |
            lsb_release -a
            export TZ=America/Los_Angeles
            export PATH="$(systemd-path user-binaries):$PATH"
      - run:
          name: Install postgresql-10
          command: |
            sudo apt-get -y purge postgresql-9.1 postgresql-9.2 postgresql-9.3 postgresql-9.4 postgresql-9.5 postgresql-9.6 || true
            wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
            sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -sc)-pgdg main" > /etc/apt/sources.list.d/PostgreSQL.list'
            sudo apt-get -y update
            sudo apt-get install postgresql-10
            sudo service postgresql start 10
      - run:
          name: Install apache
          command: |
            sudo apt-get install apache2 libapache2-mod-wsgi
            sudo ln -s /etc/apache2/conf-enabled /etc/apache2/conf.d
            sudo a2enmod ssl
            sudo a2ensite default-ssl
            sudo groupadd -o -g $(id -g www-data) apache 
      - run:
          name: Setup python
          command: |
            sudo apt-get install python3-pip
            sudo su -c 'echo /usr/lib/python3.5/site-packages > /usr/local/lib/python3.5/dist-packages/sys-site-packages.pth'
            sudo su -c 'python3 -c "import site;print(site.PREFIXES);"'
            sudo su -c 'python3 -c "import site;print(site.getsitepackages())"'
            sudo pip3 install requests
            sudo pip3 install psycopg2-binary
  install-webpy:
    steps:
      - run: 
          name: Install webpy
          command: |
            git clone https://github.com/informatics-isi-edu/webpy.git
            cd webpy
            sudo pip3 install -e
            cd ..
      # - run: sudo pip3 install git+https://github.com/informatics-isi-edu/webpy.git
  install-webauthn:
    steps:
      - run:
          name: Installing webauthn
          command: |
            sudo useradd -m -r webauthn
            sudo su -c '/usr/bin/python3 -c "import sys;import pprint;pprint.pprint(sys.path)"' - webauthn
            cd ..
            git clone https://github.com/informatics-isi-edu/webauthn.git
            cd webauthn
            sudo make testvars
            sudo make install
            sudo make deploy
            sudo bash ./test/ubuntu-travis-setup.sh
            sudo a2enmod webauthn
            sudo service apache2 restart
            cd ..

